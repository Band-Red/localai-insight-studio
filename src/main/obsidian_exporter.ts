import fs from 'fs';
import path from 'path';
import { app } from 'electron';

export class ObsidianExporter {
    public async exportChat(session: { title: string, messages: any[] }, vaultPath?: string) {
        try {
            const fileName = `${session.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}-${Date.now()}.md`;
            const targetDir = vaultPath && fs.existsSync(vaultPath)
                ? vaultPath
                : path.join(app.getPath('userData'), 'obsidian_vault');

            if (!fs.existsSync(targetDir)) {
                fs.mkdirSync(targetDir, { recursive: true });
            }

            const filePath = path.join(targetDir, fileName);

            const content = `---
type: ai-chat
session: ${session.title}
date: ${new Date().toISOString()}
tags: [localai, insight-studio, documentation]
---
# ${session.title}

${session.messages.map((m: any) => `### [${m.sender === 'user' ? 'ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' : 'ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ'}] - ${new Date(m.timestamp).toLocaleTimeString()}
${m.text}
`).join('\n---\n')}

---
*ØªÙˆÙ„Ø¯Øª Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¢Ù„ÙŠØ§Ù‹ Ø¹Ø¨Ø± LocalAI Insight Studio Ø¨ØµÙŠØºØ© Markdown Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Obsidian.*`;

            fs.writeFileSync(filePath, content, 'utf8');
            return { success: true, filePath };
        } catch (error) {
            console.error('Failed to export to Obsidian:', error);
            return { success: false, error };
        }
    }

    public async exportAudit(data: any, vaultPath?: string) {
        const fileName = `AI-Audit-${Date.now()}.md`;
        const targetDir = vaultPath && fs.existsSync(vaultPath)
            ? vaultPath
            : path.join(app.getPath('userData'), 'obsidian_vault');

        if (!fs.existsSync(targetDir)) {
            fs.mkdirSync(targetDir, { recursive: true });
        }

        const filePath = path.join(targetDir, fileName);

        const content = `---
type: audit
date: ${new Date().toISOString()}
---
# ØªÙ‚Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…

- **Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬:** ${data.cpuUsage}%
- **Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø±Ø§Ù…:** ${data.ramPercentage}%
- **Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù…Ø§Ù†:** Ø¢Ù…Ù† (Ù…Ø­Ù„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)

Generated by LocalAI Studio.`;

        fs.writeFileSync(filePath, content, 'utf8');
        return filePath;
    }
}